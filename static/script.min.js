const textarea=document.getElementById("content"),printable=document.getElementById("printable"),AUTOSAVE_DELAY=3e4;let socket,lastSavedContent=textarea.value,saveTimeout=null,toastTimeout=null;function connect(){const e=window.location.pathname.substring(1),t=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/ws/${e}`;socket=new WebSocket(t),socket.onopen=()=>{console.log("WebSocket connection established")},socket.onmessage=e=>{const t=e.data,o=document.hasFocus()&&document.activeElement===textarea;textarea.value===t||o||(textarea.value=t,lastSavedContent=t,updatePrintable(t))},socket.onclose=()=>{console.log("WebSocket connection closed. Attempting to reconnect in 2 seconds..."),setTimeout(connect,2e3)},socket.onerror=e=>{console.error("WebSocket error:",e),socket.close()}}function saveContent(){clearTimeout(saveTimeout);const e=textarea.value;if(lastSavedContent.trim()===e.trim())return;const t=window.location.pathname.substring(1),o=new URLSearchParams;o.append("content",e),fetch(`/save/${t}`,{method:"POST",body:o,keepalive:!0}).then(e=>e.ok?e.text():e.text().then(e=>{throw new Error(e)})).then(()=>{lastSavedContent=e,updatePrintable(e)}).catch(e=>{let t=e.message;e instanceof TypeError&&"Failed to fetch"===e.message&&(t="Failed to save. The note might be too large or there was a network issue."),showToast(t||"Failed to save note.")})}function scheduleSave(){clearTimeout(saveTimeout),saveTimeout=setTimeout(saveContent,3e4)}function updatePrintable(e){printable.textContent=e}function showToast(e){const t=document.getElementById("toast");t&&(t.textContent=e,t.className="show",clearTimeout(toastTimeout),toastTimeout=setTimeout(function(){t.className=t.className.replace("show","")},3e3))}textarea.addEventListener("input",scheduleSave),textarea.addEventListener("keyup",e=>{"Enter"===e.key&&saveContent()}),window.addEventListener("beforeunload",()=>{saveContent()}),textarea.focus(),updatePrintable(textarea.value),connect();